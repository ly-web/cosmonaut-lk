<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
	<head>
		<meta http-equiv='Content-Type' content='text/html; charset=GB2312'/>
		<link type='text/css' href='c_000.css' rel='stylesheet'/>
		<style type='text/css'>
			tr{height:27px;}
			.select{width:180px;_width:150px;}
			.time{width:65px;_width:100px;}
			.txt{width:70px;text-align:center;}
			.short_txt{width:50px;}
			.td_value{text-align:right;padding-right:20px;}
			.td1{padding-left:20px;padding-right:20px;text-align:left;}
			.td2{padding-left:0px;text-align:center;}
			.td3{padding-left:60px;text-align:left;}
			.td4{padding-right:5px;text-align:right;}
			.td5{padding-right:10px;text-align:right;}
			.radio{padding-left:30px;}
			.btnStyle{width:70px;height:24px;}
			.submenu{line-height:32px;padding-left:20px;width:225px;height:32px;color:#000;background-color:#eee;font-weight:normal;font-size:14px;}
		</style>	
		<script type='text/javascript'>
			var $=function(o){return document.getElementById(o);};
			function lang_init_ex(st,end){for(var i=st;i<=end;i++)eval('$(\'N'+(i<10?'0'+i:i)+'\').innerHTML=lang.N'+(i<10?'0'+i:i)+'[language];');}
			function show_tip(obj){$('tip').innerHTML=obj;}
			function show_T(tid)
			{
				var str='';
				str+="<div class='title' style='width:90%;'><div class='r1 color'></div><div class='r2 color'></div><div class='r3 color'></div><div class='r4 color'></div>";
				str+="<div class='content color'><span id='"+tid+"'></span></div>";
				str+="<div class='r4 color'></div><div class='r3 color'></div><div class='r2 color'></div><div class='r1 color'></div></div><div class='blank'></div>";
				document.write(str);
			}
			function show_sT(tid)
			{
				var str='';
				str+="<div class='title' style='width:90%;'><div class='subtitle'><div class='r1 subcolor'></div><div class='r2 subcolor'></div><div class='r3 subcolor'></div><div class='r4 subcolor'></div>";
				str+="<div class='content subcolor subcontent'><span id='"+tid+"'></span></div>";
				str+="<div class='r4 subcolor'></div><div class='r3 subcolor'></div><div class='r2 subcolor'></div><div class='r1 subcolor'></div></div><div class='line_short'></div></div>";
				document.write(str);
			}
			function show_sT_ex(tid, id)
			{
				var str='';
				str+="<div class='title' id='"+id+"' style='display:none;width:90%'><div class='subtitle'><div class='r1 subcolor'></div><div class='r2 subcolor'></div><div class='r3 subcolor'></div><div class='r4 subcolor'></div>";
				str+="<div class='content subcolor subcontent'><span id='"+tid+"'></span></div>";
				str+="<div class='r4 subcolor'></div><div class='r3 subcolor'></div><div class='r2 subcolor'></div><div class='r1 subcolor'></div></div><div class='line_short'></div></div>";
				document.write(str);
			}
			function sendHttpReq(url, successFn)
			{
				//alert(url);	
		        var xmlhttp;
		        if(window.XMLHttpRequest)xmlhttp=new XMLHttpRequest();
		        else xmlhttp=new ActiveXObject('Microsoft.XMLHTTP');
		        xmlhttp.onreadystatechange=function()
		        {
		            if(xmlhttp.readyState==4 && xmlhttp.status==200)
		            {
		                if(xmlhttp.responseText=='1'){successFn();}
		            }
		        };
		        xmlhttp.open('GET',url,true);
		        xmlhttp.send();
			}
		</script>
		<script type='text/javascript'>
			var language=0;
			//正整数+0
			var reg=/^(0|[1-9]\d*)$/;
			var Json;
			var flg_pv = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
			var lang=
			{
	 			N500:['一共','Total '],
	 			N501:['页，共',' Pages, '],
	 			N502:['页，共',' Page, '],
	 			N503:['台',' Nums'],
	 			N504:['台',' Num'],

				N541:['设置失败！','Set failed!'],
				N542:['设置成功！','Set successfully!'],
				N543:['格式错误！','Format error!'],
				N544:['范围错误！','Range error!'],

				N550:['设&nbsp;&nbsp;置','Set'],
				N551:['设&nbsp;&nbsp;置','Set'],

				//PV 串口
				N2150:['设&nbsp;&nbsp;置','Set'],
				N2151:['设&nbsp;&nbsp;置','Set'],
				N2152:['设&nbsp;&nbsp;置','Set'],
				N2153:['设&nbsp;&nbsp;置','Set'],
				N2154:['设&nbsp;&nbsp;置','Set'],
				N2155:['设&nbsp;&nbsp;置','Set'],
				N2156:['设&nbsp;&nbsp;置','Set'],
				N2157:['设&nbsp;&nbsp;置','Set'],
				N2158:['设&nbsp;&nbsp;置','Set'],
				N2159:['设&nbsp;&nbsp;置','Set'],
				N2160:['设&nbsp;&nbsp;置','Set'],
				N2161:['设&nbsp;&nbsp;置','Set'],
				N2162:['设&nbsp;&nbsp;置','Set'],
				N2163:['设&nbsp;&nbsp;置','Set'],
				N2164:['设&nbsp;&nbsp;置','Set'],
				N2165:['设&nbsp;&nbsp;置','Set'],
				N2166:['设&nbsp;&nbsp;置','Set'],
				N2167:['设&nbsp;&nbsp;置','Set'],
				N2168:['设&nbsp;&nbsp;置','Set'],
				N2169:['设&nbsp;&nbsp;置','Set'],
				N2170:['设&nbsp;&nbsp;置','Set'],
				N2171:['设&nbsp;&nbsp;置','Set'],
				N2172:['设&nbsp;&nbsp;置','Set'],
				N2173:['设&nbsp;&nbsp;置','Set'],
				N2174:['设&nbsp;&nbsp;置','Set'],
				N2175:['设&nbsp;&nbsp;置','Set'],
				N2176:['设&nbsp;&nbsp;置','Set'],
				N2177:['设&nbsp;&nbsp;置','Set'],
				N2178:['设&nbsp;&nbsp;置','Set'],
				N2179:['设&nbsp;&nbsp;置','Set'],
				N2180:['设&nbsp;&nbsp;置','Set'],
				N2181:['设&nbsp;&nbsp;置','Set'],
				N2182:['设&nbsp;&nbsp;置','Set'],
				N2183:['设&nbsp;&nbsp;置','Set'],
				N2184:['设&nbsp;&nbsp;置','Set'],
				N2185:['设&nbsp;&nbsp;置','Set'],
				N2186:['设&nbsp;&nbsp;置','Set'],
				N2187:['设&nbsp;&nbsp;置','Set'],
				N2188:['设&nbsp;&nbsp;置','Set'],
				N2189:['设&nbsp;&nbsp;置','Set'],
				N2190:['设&nbsp;&nbsp;置','Set'],
				N2191:['设&nbsp;&nbsp;置','Set'],
				N2192:['设&nbsp;&nbsp;置','Set'],
				N2193:['设&nbsp;&nbsp;置','Set'],
				N2194:['设&nbsp;&nbsp;置','Set'],
				N2195:['设&nbsp;&nbsp;置','Set'],
				N2196:['设&nbsp;&nbsp;置','Set'],
				N2197:['设&nbsp;&nbsp;置','Set'],
				N2198:['设&nbsp;&nbsp;置','Set'],
				N2199:['设&nbsp;&nbsp;置','Set'],
				N2200:['设&nbsp;&nbsp;置','Set'],
				N2201:['设&nbsp;&nbsp;置','Set'],
				N2202:['设&nbsp;&nbsp;置','Set'],
				N2203:['设&nbsp;&nbsp;置','Set'],
				N2204:['设&nbsp;&nbsp;置','Set'],
				N2205:['设&nbsp;&nbsp;置','Set'],
				N2206:['设&nbsp;&nbsp;置','Set'],
				N2207:['设&nbsp;&nbsp;置','Set'],
				N2208:['设&nbsp;&nbsp;置','Set'],
				N2209:['设&nbsp;&nbsp;置','Set']
			};

			//显示设置Mdobus地址设置框 nid -- text框id(实际的)，bid -- 确认按钮id(>=1)，tid -- 提示信息区id(>=1), num -- 添加的个数
			function show_Set(nid,bid,tid,num)
			{
				var loop=0;
				var str='';
				var style="odd";
				var more=0, all=0;
				var line=0;
				more=num%4;
				if(more!=0){all=num+(4-more);}
				else{all=num;}
				str+="<tr id='t"+(bid+line)+"' style='display:none'>";
				for(var i=0; i<all; i++)
				{
					if(i%8<4){style="odd"}else{style="even"}
					if(i>=num){
						str+="<td width='12%' class='td1 odd "+style+"'><span id='text"+(bid+i)+"'>No.Na</span></td><td width='9%' class='td2 "+style+"'><input class='txt' type='text' value='Na' disabled='true'/></td><td width='8%' class='td2 "+style+"'><button class='btnStyle' disabled='true' style='display:block;'></td>";
					}else{						
						str+="<td width='12%' class='"+style+"'><span id='text"+(bid+i)+"'>No."+(i<9?'0'+(i+1):(i+1))+"</span></td><td width='9%' class='td2 "+style+"'><input class='txt' id='ID_0x0"+(nid+i).toString(16).toUpperCase()+"' value='"+(i+1)+"' maxlength='3' onkeyup='doRangeCheck(this,reg)' type='text'/></td><td width='%8' class='td2 "+style+"'><button class='btnStyle' onclick='doSubmit(this)' id='N"+(bid+i)+"' style='display:block;'></td>";	
					}	
					if(i%4==3){
						loop=0;
						line++;
						if(i!=all-1){str+="</tr><tr id='t"+(bid+line)+"' style='display:none'>"};

					}
					loop++;
				}
				str+="</tr>";
				document.write(str);
			}				
		</script>
	</head>
	<body onload='Init()'>
		<!-- PV -->
		<table id='tbl_pv' width='90%' border='1' bordercolor="#E0E0E0" style='display:none;'>
			<script type='text/javascript'>
			show_Set(0x6B0, 2150, 2, 60);
			</script>
		</table>
		<div class='tip' id='tip1' style='width:90%;'><span>&nbsp;</span></div>	
		<div class='btm_blank'></div>
		<div id='trans'></div>
		<!--[if IE 6]><script type='text/javascript'>document.execCommand('BackgroundImageCache',false,true);</script><![endif]-->
	</body>
	<script language='javascript' type='text/javascript'>

		Json={	ID_0x0301:85,ID_0x0282:0x22,ID_0x0390:1,ID_0x0391:1,ID_0x0392:1,ID_0x0393:1,ID_0x0394:1,ID_0x0395:1,ID_0x039A:1,
				ID_0x0351:60,ID_0x0387:1,

				ID_0x06B0:1,ID_0x06B1:23,ID_0x06B2:24,ID_0x06B3:25,ID_0x06B4:27,ID_0x06B5:27,ID_0x06B6:27,ID_0x06B7:27,ID_0x06B8:27,ID_0x06B9:27,
				ID_0x06BA:27,ID_0x06BB:30,ID_0x06BC:22,ID_0x06BD:23,ID_0x06BE:24,ID_0x06BF:25,ID_0x06C0:27,ID_0x06C1:27,ID_0x06C2:27,ID_0x06C3:27,
				ID_0x06C4:27,ID_0x06C5:27,ID_0x06C6:27,ID_0x06C7:27,ID_0x06C8:27,ID_0x06C9:27,ID_0x06CA:27,ID_0x06CB:30,ID_0x06CC:27,ID_0x06CD:30,
				ID_0x06CE:27,ID_0x06CF:30,ID_0x06D0:27,ID_0x06D1:30,ID_0x06D2:24,ID_0x06D3:25,ID_0x06D4:27,ID_0x06D5:27,ID_0x06D6:27,ID_0x06D7:27,
				ID_0x06D8:27,ID_0x06D9:27,ID_0x06DA:27,ID_0x06DB:30,ID_0x06DC:22,ID_0x06DD:23,ID_0x06DE:24,ID_0x06DF:25,ID_0x06E0:27,ID_0x06E1:27,
				ID_0x06E2:27,ID_0x06E3:27,ID_0x06E4:27,ID_0x06E5:27,ID_0x06E6:27,ID_0x06E7:27,ID_0x06E8:27,ID_0x06E9:27,ID_0x06EA:27,ID_0x06EB:27			
			};
		
		function change_color(obj)
		{
			if(current_id!=obj.id)
			{
				obj.style.background='#007b3e';
				obj.style.color='#fff';
			}
		}
		function resume_color(obj)
		{
			if(current_id!=obj.id)
			{
				obj.style.background='#aaa';
				obj.style.color='#000';
			}
		}
		
		//pv
		function choose_pv()
		{
			var lin=0;
			if(Json.ID_0x0391==1){ 
				$('tbl_pv').style.display='table';
				$('tip1').style.display='block';
			} else { 
				$('tbl_pv').style.display='none';
				$('tip1').style.display='none';
			}

			//pv 串口
			for(var i=0; i<60; i++){
				if(i>=Json.ID_0x0351){
					eval('$(\'ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+'\').value=\'\';');
					eval('$(\'ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+'\').disabled=\'true\';');
					eval('$(\'N'+(2150+i)+'\').disabled=true;');
					eval('$(\'N'+(2150+i)+'\').style.background="#F0F0F0";');
					eval('$(\'text'+(2150+i)+'\').innerHTML=\'No.--\';');
				}else{
					if(Json.ID_0x0282==0x22){
						eval('$(\'N'+(2150+i)+'\').disabled=false;');
						eval('$(\'N'+(2150+i)+'\').style.background="#99D9EA";');
					}else{
						eval('$(\'N'+(2150+i)+'\').style.background="#F0F0F0";');
					} 
				}
			}
			if(Json.ID_0x0351%4==0){lin=parseInt(Json.ID_0x0351/4);}
			else {lin=parseInt(Json.ID_0x0351/4)+1;}
			for(var j=0; j<15; j++)
			{
				if(j>=lin) eval('$(\'t'+(2150+j)+'\').style.display=\'none\';');
				else eval('$(\'t'+(2150+j)+'\').style.display=\'table\';');
			}
			Set_PV_For_Serial();
		}
		
		//设置串口PV数据 
		function Set_PV_For_Serial()
		{
			var URL='s_027.html?0x06B0&time='+new Date();
			var xmlhttp;
			if(window.XMLHttpRequest)xmlhttp=new XMLHttpRequest();
			else xmlhttp=new ActiveXObject('Microsoft.XMLHTTP');
			xmlhttp.onreadystatechange=function()
			{
				if(xmlhttp.readyState==4 && xmlhttp.status==200)
				{
					eval('Json='+xmlhttp.responseText);			
					for(var i=0; i<Json.ID_0x0351; i++)
					{
						eval('$(\'ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+'\').value=Json.ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+';');
					}
				}
			};
			xmlhttp.open('GET',URL,true);
			xmlhttp.send();
		}	

		function Init()
		{
			//参数=0读所有设备地址
			var URL='s_027.html?0x0000&time='+new Date();
			var xmlhttp;
			if(window.XMLHttpRequest)xmlhttp=new XMLHttpRequest();
			else xmlhttp=new ActiveXObject('Microsoft.XMLHTTP');
			//xmlhttp.onreadystatechange=function()
			{
				//if(xmlhttp.readyState==4 && xmlhttp.status==200)
				{
					//eval('Json='+xmlhttp.responseText);

					if(Json.ID_0x0301==0x55)language=0;else language=1;
					lang_init_ex(2150,2209);

					//设备选择
					choose_pv();

					if(Json.ID_0x0282==0x11)
					{
						$('trans').style.zIndex=-9999;
					}
					else
					{
						$('trans').style.zIndex=-9999;
					}					
				}
			};
			xmlhttp.open('GET',URL,true);
			xmlhttp.send();
		}
	 	function read_back(addr)
		{ 
			var url='s_027.html?';
			
			url=url+'0xFFFF'+'&0x0'+addr.toString(16).toUpperCase();
			url=url+'&time='+new Date();
			//alert(url);

			var xmlhttp;
			if(window.XMLHttpRequest)xmlhttp=new XMLHttpRequest();
			else xmlhttp=new ActiveXObject('Microsoft.XMLHTTP');
			//xmlhttp.onreadystatechange=function()
			{
				//if(xmlhttp.readyState==4 && xmlhttp.status==200)
				{
					//eval('Json='+xmlhttp.responseText);
			        //回读PV modbus地址
			        if(addr >= 0x6B0 && addr <= 0x6EB)
	            	{
						var pr,fe;
						eval('pr=$(\'ID_0x0'+addr.toString(16).toUpperCase()+'\').value;');
						eval('fe=Json.ID_0x0'+addr.toString(16).toUpperCase()+';');
						if(pr!=fe) eval('$(\'ID_0x0'+addr.toString(16).toUpperCase()+'\').value=Json.ID_0x0'+addr.toString(16).toUpperCase()+';');	            		
		     			show_tip_ex(1, '&nbsp;');
		    			if(pr==fe){setTimeout('show_tip_ex(1,lang.N542[language])',500);}
		    			else {setTimeout('show_tip_ex(1,lang.N541[language])',500);}
			            setTimeout('show_tip_ex(1, \'&nbsp;\')',2500);               		
	            	}
				}
			};
			xmlhttp.open('GET',url,true);
			xmlhttp.send();     
        } 	

		function doSubmit(obj)
		{
            var URL='a_027.html?';

            var readBack=0;
            switch(obj.id)
           	{           		
            	//serial pv设置
            	case 'N2150': case 'N2151': case 'N2152': case 'N2153': case 'N2154': case 'N2155': case 'N2156': case 'N2157': case 'N2158': case 'N2159':
            	case 'N2160': case 'N2161': case 'N2162': case 'N2163': case 'N2164': case 'N2165': case 'N2166': case 'N2167': case 'N2168': case 'N2169':
            	case 'N2170': case 'N2171': case 'N2172': case 'N2173': case 'N2174': case 'N2175': case 'N2176': case 'N2177': case 'N2178': case 'N2179':
            	case 'N2180': case 'N2181': case 'N2182': case 'N2183': case 'N2184': case 'N2185': case 'N2186': case 'N2187': case 'N2188': case 'N2189':
            	case 'N2190': case 'N2191': case 'N2192': case 'N2193': case 'N2194': case 'N2195': case 'N2196': case 'N2197': case 'N2198': case 'N2199':
            	case 'N2200': case 'N2201': case 'N2202': case 'N2203': case 'N2204': case 'N2205': case 'N2206': case 'N2207': case 'N2208': case 'N2209':
           		var str = obj.id;
           		var cutstr = str.substring(str.length-4,str.length);
           		var index = parseInt(cutstr)-2150;
            	if(flg_pv[index]){return;}
            	eval('URL=URL+\'&0x0'+(0x6B0+index).toString(16).toUpperCase()+'=\'+$(\'ID_0x0'+(0x6B0+index).toString(16).toUpperCase()+'\').value;');
            	eval('readBack=0x0'+(0x6B0+index).toString(16).toUpperCase()+';');
            	break;
            	default:break;
           	}

            URL=URL+'&time='+new Date();
            //alert(URL);          

            function success()
            {
            	if(readBack >= 0x6B0 && readBack <= 0x6EB || (readBack >= 0x3000 && readBack <= 0x312B))
            	{
	     			show_tip_ex(1, '&nbsp;');
	    			setTimeout('read_back('+readBack+')', 100);
		            setTimeout('show_tip_ex(1, \'&nbsp;\')',2500);               		
            	}			
            } 

            //测试
            success();  

			sendHttpReq(URL, success);
		}

		function show_tip_ex(id, obj){eval('$(\'tip'+id+'\').innerHTML=obj;');}
		function doRangeCheck(obj,reg)
		{
			var range=parseInt(obj.value);
			var err, err2;			

			if(!obj.value.match(reg)){err=2;}
			else if(range<1||range>247){err=1;}
			else{err=0;}
	
			//pv	
			switch(obj.id)
			{
				case "ID_0x06B0": case "ID_0x06B1": case "ID_0x06B2": case "ID_0x06B3": case "ID_0x06B4": case "ID_0x06B5": case "ID_0x06B6": case "ID_0x06B7": case "ID_0x06B8": case "ID_0x06B9": 
				case "ID_0x06BA": case "ID_0x06BB": case "ID_0x06BC": case "ID_0x06BD": case "ID_0x06BE": case "ID_0x06BF": case "ID_0x06C0": case "ID_0x06C1": case "ID_0x06C2": case "ID_0x06C3": 
				case "ID_0x06C4": case "ID_0x06C5": case "ID_0x06C6": case "ID_0x06C7": case "ID_0x06C8": case "ID_0x06C9": case "ID_0x06CA": case "ID_0x06CB": case "ID_0x06CC": case "ID_0x06CD": 
				case "ID_0x06CE": case "ID_0x06CF": case "ID_0x06D0": case "ID_0x06D1": case "ID_0x06D2": case "ID_0x06D3": case "ID_0x06D4": case "ID_0x06D5": case "ID_0x06D6": case "ID_0x06D7": 
				case "ID_0x06D8": case "ID_0x06D9": case "ID_0x06DA": case "ID_0x06DB": case "ID_0x06DC": case "ID_0x06DD": case "ID_0x06DE": case "ID_0x06DF": case "ID_0x06E0": case "ID_0x06E1":
				case "ID_0x06E2": case "ID_0x06E3": case "ID_0x06E4": case "ID_0x06E5": case "ID_0x06E6": case "ID_0x06E7": case "ID_0x06E8": case "ID_0x06E9": case "ID_0x06EA": case "ID_0x06EB":
				if(err==1||err==2)
				{			
					for(var i=0; i<Json.ID_0x0351; i++)
					{
						if(eval('$(\'ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+'\').id')==obj.id) {flg_pv[i]=1;eval('$(\'N'+(2150+i)+'\').disabled=true;');break;}
					}
				}
				if(err==1)show_tip_ex(1,lang.N544[language]);
				else if(err==2)show_tip_ex(1,lang.N543[language]);
				else{
					for(var i=0; i<Json.ID_0x0351; i++)
					{
						if(eval('$(\'ID_0x0'+(0x6B0+i).toString(16).toUpperCase()+'\').id')==obj.id) {flg_pv[i]=0;eval('$(\'N'+(2150+i)+'\').disabled=false;');break;}
					}							
					var a=0;
					for(var i=0; i<50; i++) a|=flg_pv[i];
					if(a==0)show_tip_ex(1,"&nbsp;");						
				}
				break;
			}
		}
	</script>
</html>
